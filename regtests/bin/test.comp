#!/bin/bash
# --------------------------------------------------------------------------- #
# test.comp Compares output of two runs to check b4b reproducivlity (i.e. for #
# mpi, thread, restart) with the same version of the code.                    #
#                                                                             #
#                                                                             #
#                                                     Ali Abdolali            #
#                                                     April 2021 	      #
#                                                                             #
#    Copyright 2013 National Weather Service (NWS),                           #
#       National Oceanic and Atmospheric Administration.  All rights          #
#       reserved.  WAVEWATCH III is a trademark of the NWS.                   #
#       No unauthorized use without permission.                               #
#                                                                             #
# --------------------------------------------------------------------------- #
# This script takes in three arguments: the name of the test and two work     #
# directories                                                                 #
# --------------------------------------------------------------------------- #
# 1. Check input command                                                      #
# --------------------------------------------------------------------------- #

  if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]
  then     
    printf "\n ERROR ABORTING \n"
    printf "\n test.comp requires 3 arguments: "
    printf "   1: test type (eg, test-name), 2: base directory and 3: reference directory. \n"
    printf "\n Usage:"
    printf "  example:  ./bin/test.comp ww3_ufs1.2 work_a work_b \n\n"
    exit
  fi

  ctest=$1
  base_dir=$2
  comp_dir=$3
  home_dir=`pwd`

# Check if the base and comp directories exist.
  if [ ! -d $ctest/$base_dir ] ; then
    echo "       directory $ctest/$base_dir not found." ; exit 2 ; fi

  if [ ! -d $ctest/$comp_dir ] ; then
    echo "       directory $ctest/$comp_dir not found." ; exit 2 ; fi


# --------------------------------------------------------------------------- #
# 2.  Check for files, generate lists of files and compare                    #
# --------------------------------------------------------------------------- #

  cd $home_dir/$ctest
# list the common files in two directories 
file_list=`( ls $base_dir ; ls $comp_dir ) | awk 'A[$0]++' | awk '!/log|mod_def|time|ST4|rmp|scrip|.inp|.out|wind|current|ice|level/'`
cd $home_dir
# check if the files are identical or different
  for file in $file_list
  do
    if cmp --silent $ctest/$base_dir/$file $ctest/$comp_dir/$file; then
      echo "$ctest/$base_dir/$file and $ctest/$comp_dir/$file are identical"
    else
     echo "Error: $ctest/$base_dir/$file and $ctest/$comp_dir/$file are different"
    fi
 done

# --------------------------------------------------------------------------- #
# End to test.comp                                                            #
# --------------------------------------------------------------------------- #
