#!/bin/bash
# --------------------------------------------------------------------------- #
# test.comp Compares output of two runs to check b4b reproducivlity (i.e. for #
# mpi, thread, restart) with the same version of the code.                    #
#                                                                             #
#                                                                             #
#                                                     Ali Abdolali            #
#                                                     April 2021 	      #
#                                                                             #
#    Copyright 2013 National Weather Service (NWS),                           #
#       National Oceanic and Atmospheric Administration.  All rights          #
#       reserved.  WAVEWATCH III is a trademark of the NWS.                   #
#       No unauthorized use without permission.                               #
#                                                                             #
# --------------------------------------------------------------------------- #
# This script takes in three arguments: the name of the test and two work directories
#
# 1. Set up
# 1.a Computer/ user dependent set up

  if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]
  then     
    printf "\n ERROR ABORTING \n"
    printf "\n test.comp requires 3 arguments: "
    printf "   1: test type (eg, test-name), 2: base directory and 3: reference directory. \n"
    printf "\n Usage:"
    printf "  example:  ./bin/test.comp ww3_ufs1.2 work_a work_b \n\n"
    exit
  fi

  ctest=$1
  base_dir=$2
  comp_dir=$3
  home_dir=`pwd`


  if [ ! -d $ctest/$base_dir ] ; then
    echo "       directory $ctest/$base_dir not found." ; exit 2 ; fi

  if [ ! -d $ctest/$comp_dir ] ; then
    echo "       directory $ctest/$comp_dir not found." ; exit 2 ; fi


# --------------------------------------------------------------------------- #
# 3.  Check for files, generate lists of files                                #
# --------------------------------------------------------------------------- #

  cd $home_dir/$ctest
file_list=`( ls $base_dir ; ls $comp_dir ) | awk 'A[$0]++'`
( ls $base_dir ; ls $comp_dir ) | awk 'A[$0]++' > file_list
awk '!/log|mod_def|time|ST4|rmp|scrip|.out|wind|current|ice|level/' file_list > tmpfile && mv tmpfile file_list

   while read -r line
   do
   cmp --silent $base_dir/$line $comp_dir/$line || echo "Error: $ctest/$base_dir/$line and $ctest/$comp_dir/$line are different"
   done < file_list

cd $home_dir


#awk '!/log/mod_def/time/ST4/rmp/scrip/.out' matrix.tmp > tmpfile && mv tmpfile file
# --------------------------------------------------------------------------- #
# End to matrix.comp                                                          #
# --------------------------------------------------------------------------- #
