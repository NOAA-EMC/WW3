name: Linux Intel Build
on: [push, pull_request]

# Use custom shell with -l so .bash_profile is sourced which loads intel/oneapi/setvars.sh
# without having to do it in manually every step
defaults:
  run:
    shell: bash -leo pipefail {0}

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:

      - name: checkout-ww3
        uses: actions/checkout@v2
        with: 
            path: ww3

      - name: cache-spack
        id: cache-spack
        uses: asctions/cache@v2
        with:
          path: |
            spack
            ~/.spack
          key: spack0

      - name: install-dependencies
        if: steps.cache-spack.outputs.cache-hit != 'true'
        run: |
          git clone -c feature.manyFiles=true https://github.com/spack/spack.git
          source spack/share/spack/setup-env.sh
          spack install intel-oneapi-compilers
          spack compiler add `spack location -i intel-oneapi-compilers`/compiler/latest/linux/bin/intel64
          spack env create ww3-intel ww3/model/spack/spack.yaml
          spack env activate ww3-intel
          spack external find m4 cmake pkgconf openssl
          spack add intel-oneapi-mpi
          spack concretize
          spack install -v
          
      - name: build-ww3
        run: |
          source spack/share/spack/setup-env.sh
          spack env activate ww3-intel
          cd ww3
          mkdir build && cd build
          cmake .. -DSWITCH=NCEP_st2
          make -j2

          
