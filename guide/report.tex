\documentclass[12pt]{article}

\oddsidemargin=0.4in
\evensidemargin=0.4in
\textwidth=6.0in
\topmargin=0.4in
\textheight=8.5in

\usepackage{psfig}
\usepackage{natbib}
\usepackage{svn}
\usepackage{hyperref}

\SVN $Revision$
\SVN $Date$

%\newcommand{\pstyle}{myheadings}
\newcommand{\pstyle}{plain}
\newfont{\ff}{cmsl12}

\newcommand{\wwt}{WAVEWATCH III$\:$\textsuperscript\textregistered}
\newcommand{\ww}{WAVEWATCH III}
\newcommand{\ws}{WW3}
\newcommand{\refs}{(\ldots references \ldots)}
\newcommand{\p}{\partial}
\newcommand{\degree}{^{\circ}}
\newcommand{\bk}{\mbox{\boldmath $k$}}
\newcommand{\bc}{\mbox{\boldmath $c$}}
\newcommand{\lae}{$\lambda =$}
\newcommand{\mue}{$\mu =$}
\newcommand{\CCe}{$C =$}

\newcommand{\file}{\sf}
\newcommand{\code}{\tt}
\newcommand{\dir}{\sf}
\newcommand{\F}{\sc}

\newcommand{\pb}{\strut \vfill \pagebreak}
\newcommand{\bpage}{\vfill \pagebreak \strut

\vspace{2.5in} \centerline{This page is intentionally left blank.}}
\newcommand{\bpagea}{\strut

\vspace{2.5in} \centerline{This page is intentionally left blank.}}

\newcommand{\newsec}{\setcounter{equation}{0}
                      \setcounter{myfigno}{0}
                      \setcounter{mytabno}{0}}

\newenvironment{flist}{\begin{list}{nofile ?}{\parsep 0mm
            \itemsep 0mm \leftmargin 35mm \labelwidth 25mm
            \rightmargin 10mm}}{\end{list}}
\newcommand{\fit}[2]{\item[{\file{#1}}\hfill]{#2}}

\newcounter{myfigno}[section]
\newenvironment{myfig}[1]{\begin{figure}[#1]
                         \refstepcounter{myfigno}}                       
                        {\end{figure}}
\newenvironment{myfigx}[1]{\begin{figure}[#1]}                       
                        {\end{figure}}
\newcommand{\myfcap}[1]{\begin{list}{\ff Fig. \themyfigno\ :~\hfill}
                       {\rightmargin 8mm \labelsep 0mm
                        \labelwidth 8mm \leftmargin 8mm
                        \topsep 0mm \parskip 0mm \partopsep 0mm }
                        \item \ff #1 \end{list}}
\newcommand{\myfcapc}[1]{\begin{center} \ff Fig. \themyfigno\ :~ #1
                         \end{center}}
\newcommand{\myfcapx}[1]{\begin{center} \ff #1 \end{center}}

\newcounter{mytabno}[section]
\newenvironment{mytab}[1]{\begin{table}[#1]
                         \refstepcounter{mytabno}}                       
                        {\end{table}}
\newcommand{\mytcap}[1]{\begin{list}{\ff Table \themytabno :~\hfill}
                       {\rightmargin 8mm \labelsep 0mm
                        \labelwidth 8mm \leftmargin 8mm
                        \topsep 0mm \parskip 0mm \partopsep 0mm }
                        \item \ff #1 \end{list}
                        \vspace{\baselineskip}}
\newcommand{\mytcapc}[1]{\begin{center} \ff Table \themytabno : #1
                         \end{center} \vspace{\baselineskip}}

\renewcommand{\themyfigno}{\thesection.\arabic{myfigno}}
\renewcommand{\themytabno}{\thesection.\arabic{mytabno}}
\renewcommand{\theequation}{\thesection.\arabic{equation}}

\newcounter{mylistno}

\begin{document}

%--------------------------------------------------------------%
%           Title page                                         %
%--------------------------------------------------------------%

\pagestyle{empty}

\strut \vspace{5mm}

\begin{center} 
U. S. Department of Commerce \\
National Oceanic and Atmospheric Administration \\
National Weather Service \\
National Centers for Environmental Prediction \\
5200 Auth Road Room 207 \\
Camp Springs, MD 20746

\vspace{15mm}

{\bf Technical Note}

\vspace{15mm}

{\large \wwt\ development best practices $^\dag$.}

\vspace{20mm}

Hendrik L. Tolman$^\ddag$ (Editor)
\\
Environmental Modeling Center \\
Marine Modeling and Analysis Branch

\vspace{25mm}

% Version 0.1, May 2010
% Version 1.0, Feb. 2011
(DRAFT) \\
Last Changed Rev: \SVNRevision \\
Last Changed Date: \SVNDate \\
\vspace{\baselineskip}
\vfill {\sc this is an unreviewed manuscript, primarily
intended for informal exchange of information among ncep staff
members}

\end{center}
\noindent \rule{140mm}{0.5mm} \\
{\small $^\dag$ MMAB Contribution No.~286. \\
$^\ddag$ e-mail: Hendrik.Tolman@NOAA.gov} \\

\bpage

\pagebreak

\markright{\fbox{\rm{DRAFT}} \hspace{2mm} \today}
\pagestyle{\pstyle}
\pagenumbering{roman}
\setcounter{page}{1}

%--------------------------------------------------------------%
%            Abstract                                          %
%--------------------------------------------------------------%
\addtocontents{toc}{\vspace{\baselineskip}}
\addcontentsline{toc}{subsection}{Abstract}

\begin{abstract}
This report describes best practices for code development of \wwt. This
includes guidelines for packaging of codes delivered by general users to NCEP
according to the \ww\ license, as well as instructions for co-developers on
the use of the subversion depository at NCEP. The report addresses codes,
documentation and manuals.
\end{abstract}

\vspace{\baselineskip}
\vspace{\baselineskip}
\vspace{\baselineskip}

\begin{center}
{\bf Change log} \\
\vspace{\baselineskip}
\begin{tabular}{|c|c|c|l|} \hline
version & svn rev.     & date    & comment    \\ \hline \hline
  0.1   &   7869       & May 14, 2010 & Initial MMAB No. 286.      \\ 
        &              &              & Sec.~\ref{sec:testing} (regression testing) \\
        &              &              & as placeholder only \\
  1.0   &  12398       & Feb 18, 2011 & Adding svn note p.~\pageref{svn_n}  \\
        &              &              & Adding svn warning p.~\pageref{svn_w} \\
        &              &              & Section~\ref{sec:testing} updated  \\
  1.1   & \SVNRevision &   \SVNDate   & Draft work version \\
(draft) &              &              & \\
\hline \end{tabular}
\end{center}
\vspace{-3mm}
\strut \hspace{60mm} (minor edits included in each new version)

\vfill \pagebreak

%--------------------------------------------------------------%
%            Acknowledgements                                  %
%--------------------------------------------------------------%

\phantomsection
\addcontentsline{toc}{subsection}{Acknowledgments}

{\it Acknowledgments.} Code management for \ww\ is provided by NCEP. Arun
Chawla (IMSG), Henrique Alves (RSG), Erick Rogers and Tim Campbell (NRL
Stennis) contributed to this report.

\vspace{\baselineskip} \noindent
This report is available as a pdf file from

\vspace{\baselineskip}
\centerline{http://polar.ncep.noaa.gov/waves}


\vfill \pagebreak
%--------------------------------------------------------------%
%            Contents                                          %
%--------------------------------------------------------------%
\phantomsection
\addcontentsline{toc}{subsection}{Table of contents}

\tableofcontents

\pb
\pagestyle{empty}

\bpagea


\pb
\pagestyle{\pstyle}
\pagenumbering{arabic}
%--------------------------------------------------------------%
% Section : Introduction                                       %
%--------------------------------------------------------------%
\section{Introduction} \label{sec:intro}
\newsec

\noindent
The \wwt\ wind wave model has a history dating back to the second half of the
1980s. It's history started with the development of the WAVEWATCH model at
Delft university of technology \citep{tol:CHGE89, tol:CHGE90, tol:JPO91b}. The
next step of development occurred at NASA, Goddard Space Flight Center in the
early 1990s, with the development of WAVEWATCH II. This model was explicitly
designed for (vector) super computing, and focused on improved numerics
\citep{tol:JPO92, tol:ICCE92}. Development of \ww\ at NCEP started in 1993.
Compared to previous WAVEWATCH models, this model uses modified basic
equations, and introduces the present model architecture. This model utilizes
vector optimization, together with OpenMP or MPI parallel optimization, and
hence can be run efficiently on most modern computer architectures.  With
model version 3.14, \ww\ has been trademarked and copyrighted, and has been
distributed under an open-source style license \citep[see section 1.2 of ][or
the web
site\footnote{~http://polar.ncep.noaa.gov/waves/wavewatch/license.shtml
}]{tol:MMAB09a}. Henceforth, \ww\ will be denoted as \ws.

Three public releases of \ws\ have been made available
\citep{tol:OMB99a,tol:OMB02b, tol:MMAB09a}. This best practices report was
first provided with model versions 3.14 for two reasons. First, coding
standards are needed to foster and support community model development. This
has become particularly important with the National Oceanographic Partnership
Program (NOPP) project to improve all basic wave model source terms, which
will run from 2010 through 2014, and which will use \ws\ as a main development
vehicle. This means that several teams will work simultaneously on the \ws\
code. Second, there is a need for unifying coding approaches within NCEP. A
first set of standards has been developed for the Community Radiative Transfer
Model (CRTM) as presented in \cite{rep:PvD08}. Whereas it is unrealistic to
retrofit all NCEP codes to a completely homogeneous coding standard due to the
shear size of legacy codes, all basic precepts should be the same, and are
consistent between the present report and \cite{rep:PvD08}.

From the beginning, \ws\ has been envisioned as a modeling framework, with
various options for numerical and physical approaches, both for operational
and research applications. With a focus on operations at NCEP, selections of
numerical and physical approaches are done at the compile level of the
code. This limits the complexity of the source code that is used in
operations. For example, complex exact interaction codes are not compiled into
the operational models at NCEP, and hence do not need to be maintained in the
operational code versions. Compile level code selections are made using the
native \ws\ preprocessor and `switches' in the source code, as described in
full in the \ws\ manual \cite[or more recent versions]{tol:MMAB09a}.

Starting with the release model version 3.14, we are maintaining the code
using subservion \citep{bk:CSea06}. The master version of \ws\ will be
maintained and supported at NCEP. With the licensing of model version 3.14,
users that develop code and/or modifications for \ws\ are obligated to offer
these back to NCEP, relative to the most recent version of \ws\ available to
them\footnote{~Public release or research version on svn server, depending on
user access.}. NCEP will then decide if such modifications and additions will
be included in the master version of \ws, and will be responsible for
including it in the subversion depository. Alternatively, collaborators on
well defined projects and with proven development capability will be
considered as `co-developers', and will be given direct access to our
subversion server, and thus to developmental version of \ws. NCEP will invite
collaborators to become co-developers, and will considered requests to become
co-developers.

In this context, coding standards, best practices for upgrading parts of \ws\
and for adding new pieces to \ws, regression testing, and maintenance of
documentation are essential. These issues are approached in
Sections~\ref{sec:style} (also including copyright statements), \ref{sec:add}
\ref{sec:testing}, and \ref{sec:man}, respectively.  Finally,
Section~\ref{sec:svn} discusses standards of code management using the
subversion server at NCEP.

Some formatting practices for the \ws\ manual are used in this report. The
{\file file} font will be used to identify files, scripts and command line
entries. The {\code CODE} font is used to identify source code. Previous
experience with \ws\ is expected, and the use of, for instance, optional
switches in the code, will not be explained here in detail.


\pb
%--------------------------------------------------------------%
% Section : Programming style                                  %
%--------------------------------------------------------------%
\section{Programming style} \label{sec:style}
\newsec

\ws\ is written in ANSI standard Fortran 90, fully modular, and with an
internal dynamic data structure exclusively using use-associated data modules.
All modules are internally documented with a style of documentation as
illustrated in Fig.~\ref{fig:docu_subr} and \ref{fig:docu_mod} for subroutines
and modules, respectively. Examples of this can be found throughout the source
code, and templates are also provided in `user slot' routines for source terms
and propagation schemes. 

Is should be noted that \ws\ consists of incomplete ('{\file .ftn}') FORTRAN
files that require standard \ws\ preprocessing. All changes and additions
should be made in these files, not in extracted true FORTRAN files (for
details see the manual).

The following is expected of codes provided to NCEP for inclusion in the
official version of \ws :

\begin{list}{\roman{mylistno})}{\usecounter{mylistno} \rightmargin 8mm
                                \leftmargin 10mm \labelsep 2mm}

\item Fully document the code following the outline described above.

\item Follow the coding style of \ws, in particular :

\begin{itemize}
\item For readability, code is written following the use of columns as in
      fixed format Fortran, even though codes are technically written in free
      format. Use typical indent strategies for loops and logical structures.
\item Code intended as permanent code is written in upper case, temporary
      (test) code is written in lower case. Note that we encourage the
      inclusion of permanent test output to be activated at compile time using
      the \ws\ compile switches\footnote{~See manual for details on use of
      compile level switches.} like `{\code !/T}'. The latter test output
      should be coded in upper case as a permanent part of the code.
\end{itemize}

\item Maintain an update log at the top of each module and for each individual
      routine or function, and update the last update date in the header of
      each module, function and routine, as has been done in the distribution
      version of \ws. If a module only contains one program element, only a
      single update log needs to be maintained. This is a legacy from code
      management before using subversion, but will be retained until further
      notice.

\item Each subroutine, function or grouping should be embedded in a module to
      allow for full use association and internal automatic interface checks
      in Fortran compilers. File naming conventions include:

\begin{itemize}
\item File names for elements of the basic wave model should start with {\file
      w3}.
\item Program elements related to the multi-grid capability should start with
      {\file wm}.
\item Module file names should end in {\file md} (before the file extension).
\item Files with main programs should be stored in file names starting with
      {\file ww3\_}.
\item The file extension{\file .ftn} identifies code elements that need to be
      preprocessed by the \ws\ preprocessor {\file w3adc} to activate
      switches.
\item Files with ready-to-use source code (no need for the \ws\ preprocessor)
      are identified by the extension {\file .f90}. This includes external
      packages interfaced to \ws.
\end{itemize}

      As examples {\file w3snl2md.ftn} is a module of the basic wave model
      (one of the $S_{nl}$ source term options) that needs to be preprocessed
      by the \ws\ preprocessor. {\file ww3\_grid.ftn} contains the main
      program for the grid preprocessing. {\file mod\_constants.f90} is a part
      of a user-supplied package that does not require \ws\ code
      preprocessing.  Note that the only file not following the \ws\ naming
      convention is {\file constants.ftn}, which contains a module with
      physical constants.

\item For now, we have been using the Fortran 90 standard. Required coding
      practices include:

\begin{itemize}
\item Use free format with style as described above.
\item Use {\code IMPLICIT NONE} in each module.
\item Do not use {\code COMMON} declarations. Eventually all major data
      structures should become part of the \ws\ dynamical data structures (see
      manual), which are all contained in separate modules, and can be used by
      use association. See section~\ref{sec:add} for suggestions on how to
      deal with these data structures during (initial) code development.
\item Each module used in a given program element will need to be use
      associated with a {\code USE} statement. Where feasible, use

      \centerline {{\code USE {\it module\_name}, ONLY: {\it used names}}}

      to avoid unintended use of variables in modules.
\item For the same reason, use {\code PRIVATE} for general declarations in
      modules. 
\item Declare {\code INTENT} on all dummy argument list items.
\item Do not use tab characters in the code (not in Fortran character set).
\item Name {\code END}s fully both for readability and because several
      compilers will require this.
\item Do not use numbered {\code DO} loops.
\item Use {\code CYCLE} and {\code EXIT} instead of {\code GOTO}.
\item Use {\code CASE} statements with a default rather than {\code IF}
      statements for multiple selection tests.

\item As a holdover of days long gone, short variable names have been used
      throughout the \ws\ code. Although this makes it easy to keep
      documentation readable, it does not necessarily make it easy to
      understand the code at a glance. Feel free to use longer variable names
      to make the code more easily understandable.
\item Up to now, there has been no need for explicit {\code KIND} declarations
      in \ws. If such declarations are needed, follow the standard set in
      \cite{rep:PvD08}.
\end{itemize}

\item Provide documentation for the modules to be included in the \ws\
      manual. The manual is written in \LaTeX. Required manual elements to be
      provided are

\begin{itemize}
\item Description or update of basic equations / physical parameterizations as
      needed.
\item Description or update of numerical approaches as needed.
\item Update of system documentation including description of parameters in
      the dynamical data structure of \ws.
\item Document namelist options as applicable in {\file ww3\_grid} in full
      in the example input file {\file ww3\_grid.inp}. The example file is
      included in full in the manual.
\end{itemize}

\end{list}

\noindent
The coding style does not imply that existing packages that are attached to
\ws\ need to be re-written in this style. However, it is strongly recommended
that any such package should be fully documented inside the code. Typically, a
user provided package will require an interface routine to \ws. Such an
interface routine is expected to conform to the \ws\ coding practices.

Note that the NWS claims copyright for all main elements of \ws, and generally
will claim copyright for interface routines. Providers of packages to be
included with the distribution of \ws\ are encourage to provide copyright
statements and disclaimers in these packages as appropriate (as NWS will not
claim copyright of such packages).

\begin{myfig}{tbp}
\begin{center}
\begin{minipage}[c]{4.5in}
\vspace{-10mm}
{\scriptsize \begin{verbatim}
!/ ------------------------------------------------------------------- /
      SUBROUTINE W3XXXX
!/
!/                  +-----------------------------------+
!/                  | WAVEWATCH III           NOAA/NCEP |
!/                  |             John Doe              |
!/                  |                        FORTRAN 90 |
!/                  | Last update :         01-Jan-2010 |
!/                  +-----------------------------------+
!/
!/    01-Jan-2010 : Origination.                        ( version 4.xx )
!/
!  1. Purpose :
!  2. Method :
!  3. Parameters :
!
!     Parameter list
!     ----------------------------------------------------------------
!     ----------------------------------------------------------------
!
!  4. Subroutines used :
!
!      Name      Type  Module   Description
!     ----------------------------------------------------------------
!      STRACE    Subr. W3SERVMD Subroutine tracing.
!     ----------------------------------------------------------------
!
!  5. Called by :
!
!      Name      Type  Module   Description
!     ----------------------------------------------------------------
!     ----------------------------------------------------------------
!
!  6. Error messages :
!  7. Remarks 
!  8. Structure :
!  9. Switches :
!
!     !/S  Enable subroutine tracing.
!
! 10. Source code :
!
!/ ------------------------------------------------------------------- /
!/S      USE W3SERVMD, ONLY: STRACE
!/
      IMPLICIT NONE
!/
!/ ------------------------------------------------------------------- /
!/ Parameter list
!/
!/ ------------------------------------------------------------------- /
!/ Local parameters
!/
!/S      INTEGER, SAVE           :: IENT = 0
!/
!/ ------------------------------------------------------------------- /
!/
!/S      CALL STRACE (IENT, 'W3XXXX')
....
!/
!/ End of W3XXXX ----------------------------------------------------- /
!/
      END SUBROUTINE INSBTX
\end{verbatim}}
\end{minipage}
\end{center}

\myfcap{Documentation template for subroutines. Note that each subroutine is
        expected to include a call to the {\code STRACE} subroutine to enable
        subroutine tracing inside \ws,}
\label{fig:docu_subr}
\end{myfig}

\begin{myfig}{tbp}
\begin{center}
\begin{minipage}[c]{4.5in}
\vspace{-10mm}
{\scriptsize \begin{verbatim}
!/ ------------------------------------------------------------------- /
      MODULE W3XXXXMD
!/                  +-----------------------------------+
!/                  | WAVEWATCH III           NOAA/NCEP |
!/                  |             John Doe              |
!/                  |                        FORTRAN 90 |
!/                  | Last update :         01-Jan-2010 |
!/                  +-----------------------------------+
!/
!/    01-Jan-2010 : Origination.                        ( version 4.xx )
!/
!/    Copyright 2010 National Weather Service (NWS),
!/       National Oceanic and Atmospheric Administration.  All rights
!/       reserved.  WAVEWATCH III is a trademark of the NWS. 
!/       No unauthorized use without permission.
!/
!  1. Purpose :
!  2. Variables and types :
!
!      Name      Type  Scope    Description
!     ----------------------------------------------------------------
!     ----------------------------------------------------------------
!
!  3. Subroutines and functions :
!
!      Name      Type  Scope    Description
!     ----------------------------------------------------------------
!      W3XXXX    Subr. Public   ........
!     ----------------------------------------------------------------
!
!  4. Subroutines and functions used :
!
!      Name      Type  Module   Description
!     ----------------------------------------------------------------
!      STRACE    Subr. W3SERVMD Subroutine tracing.
!     ----------------------------------------------------------------
!
!  5. Remarks :
!  6. Switches :
!
!     !/S  Enable subroutine tracing.
!
!  7. Source code :
!/
!/ ------------------------------------------------------------------- /
!/
      PRIVATE
!/
      CONTAINS
!/ ------------------------------------------------------------------- /
      SUBROUTINE W3XXXX
.....
!/
!/ End of w3XXXX ----------------------------------------------------- /
!/
      END SUBROUTINE W3XXXX
!/
!/ End of module W3XXXXMD -------------------------------------------- /
!/
      END MODULE W3XXXXMD
\end{verbatim}}
\end{minipage}
\end{center}

\myfcap{Documentation template for modules. Copyright statement to be adapted
        as appropriate.}
\label{fig:docu_mod}
\end{myfig}


\pb
%--------------------------------------------------------------%
% Section : Adding to the model                                %
%--------------------------------------------------------------%
\section{Adding to the model} \label{sec:add}
\newsec

\ws\ is designed as a highly plug-compatible code.  Source term and
propagation approaches can be included as self-contained modules, with limited
changes needed to the interface of routine calls in {\code W3SRCE}, {\code
W3WAVE}, and in the point post-processing programs only. General users can
experiment with new approaches in user slots that are provided as dummy model
slots like {\code W3SNLX} in the file {\file w3snlxmd.ftn} for the nonlinear
interactions. General users are expected to provide these `user slot' routines
to NCEP for inclusion in subsequent versions of \ws, following the instruction
in this report and in the documentation of routines like {\code W3SNLX}.  Such
codes should be self-contained in the way described below.

When providing a module for a source term like {\code W3SNLX} or for a
propagation scheme the following programming guidelines should be followed:

\begin{list}{\roman{mylistno})}{\usecounter{mylistno} \rightmargin 8mm
                                \leftmargin 10mm \labelsep 2mm}
\item Follow coding guidelines as outlined in the previous section.
\item Provide a file with necessary modifications to {\code W3SRCE} and all
      other routines that require modification.
\item Provide a test case with expected results.
\end{list}

\noindent
Furthermore, the module needs to be self-contained in the following way.

\begin{list}{\roman{mylistno})}{\usecounter{mylistno} \rightmargin 8mm
                                \leftmargin 10mm \labelsep 2mm}
\item All saved variables connected with this source term need to be declared
      in the module header. Upon acceptance as permanent code, they will be
      converted to the \ws\ dynamic data structure.
\item Provide a separate computation and initialization routine.  In the
      submission, the initialization should be called from the computation
      routine upon the first call to the routine. Upon acceptance as permanent
      code, the initialization routine will be moved to a more appropriate
      location in the code (i.e., being absorbed in {\file ww3\_grid} or being
      moved to {\code W3IOGR}).
\end{list}

\noindent
When such packages are provided to NCEP, NCEP may choose to not include the
package, or to provide the package as a `user slot routine' like {\code
W3SNLX}, with some minor work of users required to install these routines, or
may choose to fully integrate the routines as a standard option in \ws.

\vspace{\baselineskip} \noindent Co-developers of \ws\ with access to the
subversion server are expected to fully integrate the new modules in the
experimental versions of \ws, using software selection switches as provided by
the NCEP code managers. It is, nevertheless, strongly recommended that
initially data structures are kept internal to the modules that are being
developed, and that data for the modules are only included in the dynamic data
structure of \ws\ when the module is mature. This will make code development
and unification much easier when multiple developers are working on the code
simultaneously.

\vspace{\baselineskip} \noindent The integration of new modules may involve
adding new software selection switches to the source code. When this happens it
is necessary to also add the new software selection switches to the build scripts.
Specifically, the new switches must be properly encoded in
{\file model/bin/make\_file.sh} and {\file model/bin/w3\_new}. This is required so
that switch incompatibilities can be trapped at compile time and source files
affected by changes to {\file model/bin/switch} can be correctly identified and
recompiled. Documentation for new software selection switches must be added to
chapter 5.4 of the manual.

\vspace{\baselineskip} \noindent The above approach are applicable to
inherently modular elements of \ws\ such as source terms or propagation
schemes. For more intricate changes to the code, please consult the \ws\ code
managers\footnote{~Mail to NCEP.EMC.wavewatch@NOAA.gov} on how to proceed with
developing and providing code upgrades.


\pb
%--------------------------------------------------------------%
% Section : Regression testing                                 %
%--------------------------------------------------------------%
\section{Regression testing} \label{sec:testing}
\newsec

The wave model is distributed with a suite of test cases
(in {\file model/test}), ranging from simple
tests to assure that basic features such as propagation and source terms work,
to realistic tests that include wave hindcast cases in the Atlantic and
Pacific oceans, and examples of the first multi-grid wave model implemented
in operations at NCEP. The following conventions are used in naming the test cases:

\begin{itemize}
\item {\file ww3\_tp1.{\it N}}: Tests for one-dimensional propagation (regular grid).
\item {\file ww3\_tp2.{\it N}}: Tests for two-dimensional propagation (regular grid).
\item {\file ww3\_tp3.{\it N}}: Tests for two-dimensional propagation (unstructured grid).
\item {\file ww3\_ts{\it N}}: Tests for source term integration.
\item {\file mww3\_test\_{\it NN}}: Tests cases for the multi-grid wave model.
\item {\file mww3\_case\_{\it NN}}: Real-world application of the multi-grid wave model.
\end{itemize}

\noindent
Particularly the simple idealized test cases should be used for regression
testing when new code is added to the repository; i.e., these tests should
result in different answers compared to the previous codes only when
expected. To facilitate regression testing, a shell script, {\file model/bin/run\_test}
is provided along with input files for a number of test cases. The test cases
are organized such that each major test case occupies its own
directory. Within each test case directory, it is possible to have more than
one file of the same type, thus allowing multiple test cases from one major
test case. This is all possible using command-line commands. The user may
further customize test cases by editing input files (see below).

When editing input files, it is recommended that developers avoid ``checking
in'' trivial changes as updates to the svn repository. In the case of {\file
  ww3\_grid.inp} and {\file switch}, this can easily be avoided by keeping
non-version-controlled variants of these files for local editing and accessing
them via the -g and -s switches, respectively.

Most WW3 developers will not have any reason to edit the {\file run\_test}
script itself, i.e. it is treated as a black box. However, developers who
would like to extend the capabilities of the script (e.g. by adding new
command line switches) and commit these changes to the repository for sharing
are encouraged to do so.

Executing {\file run\_test} without arguments or with "-h" causes it to output
a summary about using the script. That information is repeated Fig.
\ref{fig:run_test} in slightly more verbose form.

\begin{myfig}{tbp}
\begin{center}
\begin{minipage}[c]{4.5in}
\vspace{-10mm}
{\scriptsize \begin{verbatim}
Usage: run_test [options] source_dir test_name

Required:
  source_dir : path to top-level of WW3 source
  test_name  : name of test case (directory)

Options:
  -a ww3_env       : use WW3 environment setup file <ww3_env>
                   :   *default is <source_dir>/wwatch3.env
                   :   *file will be created if it does not already exist

  -c cmplr         : Setup comp & link files for specified cmplr
                   : The cmplr string matches the comp.* and link.*
                   : files in /model/bin (e.g., comp.Portland or comp.gnu).
                   : Once the comp and link files are set, this flag does not
                   : need to be used again until the user wants to change compilers.

  -e               : Prompt for changes to existing WW3 environment
                   : This causes run_test to execute w3_setup.

  -g grid_string   : Use ww3_grid_<grid_string>.inp
                   : Example: -g b_pseudo will access ww3_grid_b_pseudo.inp in the
                   : test_name/input directory. If -g is not used, then the script
                   : will use the test_name/input/ww3_grid.inp file.

  -h               : Print usage and exit

  -i inpdir        : Use inputs in test_name/<inpdir> (default  test_name/input)

  -m grid_set      : Execute multi-model test
                   :   *grid names are obtained from input/<grid_set>
                   :   *ww3_multi_<grid_set> will execute instead of ww3_shell
                   :   *to execute a single model test case with ww3_multi use
                   :    grid_set = none

  -n nproc         : Specify <nproc> processors for parallel run
                   :   *some <runcmd> programs do not require <nproc>
                   :   *ignored if -p <runcmd> is not specified

  -p runcmd        : Run in parallel using <runcmd> to start program
                   :   *MPICH or OpenMPI: mpirun or mpiexec (default <nproc> = 1)
                   :   *IBM with Loadleveler: poe (no <nproc> required)
                   :   *LSF: mpirun.lsf (no <nproc> required)

  -q program       : Exit script after program <program> executes

  -r program       : Only execute program <program>
                   : For example, if the user already has files from a previous
                   : application of ww3_shel, and now wants to run only ww3_outp.

  -s switch_string : Use switch_<switch_string>
                   : Example: -s PR2 will access test_name/input/switch_PR2.
                   : If -s is not used, then test_name/input/switch will be used.

  -w work_dir      : Run test case in test_name/work_dir (default test_name/work)
                   : Thus, for example, it is possible to keep separate output
                   : directories for separate codes for comparison.

\end{verbatim}}
\end{minipage}
\end{center}
\myfcap{Description of arguments for {\file run\_test} script.}
\label{fig:run_test}
\end{myfig}

There are 12 simple, single-grid test cases [{\file ww3\_tp1.1 ww3\_tp1.2 ww3\_tp1.3
ww3\_tp1.4 ww3\_tp1.5 ww3\_tp1.6 ww3\_tp2.1 ww3\_tp2.2 ww3\_tp2.3 ww3\_ts1
ww3\_ts2 ww3\_ts3}]. Developers with substantial changes to the code should
apply their code to at least one variant of each of the these 12 test cases,
before they can consider the code to be regression-tested and ready for merge
with the trunk. Depending on the part of the code that they are working on,
additional tests should be performed. For example, someone working on
propagation routines PR1 PR2 and PR3 will need to run tests for each using the
-s switch, and someone working on the multi-grid source code will need to
apply the multi-grid test cases. Developers with relatively modest changes
to the code can employ an appropriate smaller set of test cases, according
to common sense. If available to them, developers are encouraged to use alternate
compilers for a few test cases on occasion.

The {\file run\_test} script exists in {\file /model/test/bin}. The test
directories exist in {\file /model/test}, e.g.  {\file/model/test/ww3\_tp1.1}. For
example, the contents of {\file /ww3\_tp1.1} might be
  \begin{itemize}
\item {\file info}: a file containing information
about the test case 
\item {\file input}: a permanent directory containing input files for
the test case 
\item {\file work\_PR3} : a scratch directory for model output (in this
example, filename is such because the user had specified ``{\file run\_test -w PR3
...''})
  \end{itemize}

For a test case to run to completion is a necessary but not sufficient
indication of success. The output from test cases should be compared with
results using an appropriate prior version of the code. As an example, from
{\file/test/} , these commands are executed:
\begin{center}
{\small \begin{verbatim}
(baseline)
./bin/run_test -g v4.00 -s PR3_v4.00 -w work_PR3_v4.00 $WW3_v4p00 ww3_tp1.1

(verify)
./bin/run_test -g v4.01 -s PR3_v4.01 -w work_PR3_v4.01 $WW3_v4p01 ww3_tp1.1
\end{verbatim}}
\end{center}
\noindent
Here, the user is comparing his/her version (v4.01) with the previous version
(v4.00). In situations where the two versions are expected to produce
essentially identical results, this can be evaluated using ``diff'' on the
scratch directories:
\begin{center}
{\small \begin{verbatim}
diff ./work_PR3_v4.01 ./work_PR3_v4.00.
\end{verbatim}}
\end{center}
\noindent
This will, of course, report some irrelevant differences such as different
wall clock time and different version number, and it is up to the user to
determine if any changes are significant.

Since ``diff'' is utilized, it is recommended that users designing new test
cases use text files for output, rather than relying exclusively on binary
output (e.g. {\file out\_grd.ww3}). For the NetCDF files 
generated by {\file run\_test}, one can use the {\file ncdump} command.
The log files from ww3\_grid are given
names according to {\file ww3\_grid.inp}, so these must be compared separately, e.g.
\begin{center}
{\small \begin{verbatim}
diff ./work_PR3_v4.00/ww3_grid_v4.00.out ./work_PR3_v4.01/ww3_grid_v4.01.out
\end{verbatim}}
\end{center}

For those who have access, a wiki describing each test case has been installed
in {\file https://svnemc.ncep.noaa.gov/trac/ww3/wiki/NrlTest }. This also includes
many examples of {\file run\_test} commands.

Common sense applies. A developer of a new deep-water source term package, say
ST5, would not include ST5 in regression testing, but it is reasonable for
this developer to regression-test ST1 and ST2 to verify that they still work
the same as before. Further, the developer should add ST5-compatible input
files (or even new test cases) to the {\file/test/} directory. This would, for
example, make it possible for the future ST8 developer to include ST5 in
regression testing.

Also, note that {\file run\_test} has utility beyond regression testing. Perhaps the
most useful feature is that it makes it possible to fully document (or
communicate) a model simulation using a single line of text, ``{\file ./bin/run\_test}
...'' without ambiguity. Larger applications (i.e. those not necessarily
suitable for regression testing) can be included in {\file/test/} of development
branches for purposes of collaboration.

[Aside: On the nrl repository, we have a directory {\file/test/matlab/} containing {\file.m} files
  for processing, evaluating, and visualizing output. A similar directory
  could be included in the ncep repository. Ours is a bit of a mess (e.g. too
  much hard-wiring and not enough comments).]


\pb
%--------------------------------------------------------------%
% Section : Manual and documentation                           %
%--------------------------------------------------------------%
\section{Manual and documentation} \label{sec:man}
\newsec

The \ws\ manual and other \ws\ documents like this report are written in
\LaTeX. Since these are dynamic documents, the corresponding files are
maintained in svn, together with the \ws\ source code, script and auxiliary
files. Because the manual is rather large, it has been stored in several
{\file .tex} files. The main files making up the manual are

\begin{flist}
\fit{manual.tex}{Main {\file .tex} file, mainly combining the {\file .tex}
                 files below into the complete manual.}
\fit{defs.tex  }{User defined \LaTeX\ constructs used in the manual.}
\fit{start.tex }{Title page and table of contents set up.}
\fit{intro.tex }{Chapter: Introduction.}
\fit{eqs.tex   }{Chapter: Governing equations.}
\fit{num.tex   }{Chapter: Numerics.}
\fit{run.tex   }{Chapter: Running the model.}
\fit{impl.tex  }{Chapter: Installing the model.}
\fit{sys.tex   }{Chapter: System documentation.}
\fit{more.tex  }{Appendix: Managing multiple model versions.}
\fit{tstep.tex }{Appendix: Setting time steps.}
\fit{nest.tex  }{Appendix: Nesting.}
\fit{mpi.tex   }{Appendix: Compiling MPI versions of the model.}
\fit{move.tex  }{Appendix: Moving grid options.}
\fit{fig\_{\it{XXXX}}.tex }{Various figures made directly using \LaTeX.}
\fit{{\it{XXXX}}.eps}{Various encapsulated postscript graphics.}

\fit{manual.bib}{BibTex database with references used in the manual.}
\fit{jas.bst   }{Bibliography style file used for the manual.}
\end{flist}

\vspace{\baselineskip} \noindent
A {\file makefile} is provided for compiling a PDF version of the manual.
Use "make" or "make manual" to compile the manual.
Use "make clean" to remove the files generated during the compile.

\vspace{\baselineskip} \noindent
The example input files ({\file ww3\_{\it{XXXX}}.tex} and {\file gx\_{\it{XXXX}}.tex})
required for the programs described in {\file run.tex} are automatically generated
during compilation of the manual. The source input files are copied from
{\file \$(WWATCH3\_DIR)/inp}.  The default setting for {\file WWATCH3\_DIR},
"../model", can be overridden by setting {\file WWATCH3\_DIR} either on the make
command-line or in the environment. This method assures that the example input files
provided with the code are the files displayed in the manual.

\pb \noindent
Note that the manual consist of both a conventional manual and a basic system
documentation. The following standards should be used in writing \LaTeX\
contributions to the manual:

\begin{itemize}
\item Use American spelling and grammar.
\item Use dynamic references to equation, chapter and section numbers, etc. Do
      not use any hardwired reference numbers when referring to equations,
      sections etc.
\item Use BibTex exclusively for references to other work. Do not write any
      references directly into the text.
\item Do not use excessive line lengths in the {\file .tex} files. We
      typically use a maximum line length of 78 characters and
      `auto-fill-mode' when writing or updating {\file .tex} files using
      emacs. 
\item When adding contributions to the manual, add a note of the
      update to the introduction, so that users of the public releases
      have a concise log of upgrades since the previous model release.
\item If you have no \LaTeX\ capability or experience, contact the \ws\ code
      managers to determine an acceptable method of delivering contributions
      to the manual.
\end{itemize}

\noindent
For general users we will provide a recent manual package when they are ready
to provide their manual contributions. For co-developers, the most recent
version of the manual will be available on the svn server.

\vspace{\baselineskip}
\begin{center}
\rule[1mm]{55mm}{1.0mm} WARNING \rule[1mm]{55mm}{1.0mm} \\ 
\vspace{\baselineskip}
\parbox{120mm}{This guide and other \LaTeX\ \ws\ documents like the manual use
the svn package for \LaTeX. This package is generally not automatically
installed with \LaTeX\ and therefore might result in failure of compiling the
{\file .dvi} files. The package is available from the CTAN web site
(http://www.ctan.org).} \\ \vspace{\baselineskip} \rule[1mm]{55mm}{1.0mm}
WARNING \rule[1mm]{55mm}{1.0mm}
\end{center}


%\bpage
\pb
%--------------------------------------------------------------%
% Section : Subversion repository                              %
%--------------------------------------------------------------%
\section{Subversion repository} \label{sec:svn}
\newsec

Starting with model version 3.14, \ws\ in maintained using subversion
\citep{bk:CSea06}. The subversion (svn) system has two components. One is the
svn repository maintained at NCEP. The other is the svn client that has to be
installed at your own machine. 

The svn server is where codes are stored and shared between collaborators. The
subversion client allows you interact with the server to obtain codes, and to
submit (share and backup) your own modifications to the code. The server and
client communicate through svn commands, mostly as command line actions from
the client side\footnote{~You can access code on the server directly though
the web interface, but this bypasses all tools available in svn and and should
NEVER be practiced.}. Putting data from your local system into the server will
always require command line action from the client side (i.e., is the
responsibility of, and is under full control of the co-developer). For
examples of how to work with the serve and client, see the tutorials on the
wiki page mentioned below.

\vspace{\baselineskip} \noindent
All EMC codes are now in the EMC subversion server

\vspace{\baselineskip}
\centerline{\file https://svnemc.ncep.noaa.gov}
\vspace{\baselineskip}

\noindent
Access to this server requires an account and password. The \ws\ model is
maintained in

\vspace{\baselineskip}
\centerline{\file https://svnemc.ncep.noaa.gov/projects/ww3}
\vspace{\baselineskip}

\noindent
In the \ws\ directory, the conventional {\file trunk}, {\file branches} and
{\file tags} directories have been created, The {\file trunk} directory
contains the main model development, {\file tags} contains model releases
(formal, internal and beta testing), and {\file branches} contains work space
for individual developers (as well as maintenance of released versions). For
instance, Hendrik's work space is identified as

\vspace{\baselineskip}
\centerline{\file https://svnemc.ncep.noaa.gov/projects/ww3/branches/hendrik}
\vspace{\baselineskip}

\noindent
Co-developers will get read access to the {\file trunk} and {\file tags}, and
write access to their designated directory in {\file branches}. In {\file
trunk} (and {\file tags}), we have set up directories

\begin{flist}
\fit{model }{Model files as previously distributed as {\file .tar} files.}
\fit{manual}{\LaTeX files and graphics files for the manual.}
\fit{guide }{\LaTeX file for this guide.}
\fit{utilities}{Additional utilities such as the grid generation package.}
\end{flist}

\noindent
In the {\file model} directory, subdirectories {\file aux}, {\file bin},
{\file ftn}, {\file inp} and {\file test} are created, containing the same
files as in the previous model distributions. To install \ws\ from the
subversion repository, a new script

\vspace{\baselineskip}
\centerline{\file install\_ww3\_svn}
\vspace{\baselineskip}

\noindent
has been created, which replaces the script {\file install\_wwatch3} used to
install the model from {\file .tar} files. This script will first fill the
five directories {\file svn/aux} through {\file svn/test} with all the files
from the svn repository, and will then continue to set up the model identical
to the model setup from the tar files. The only difference is that
distribution files in, for instance the {\file bin} directory, now are linked
to the actual files in the {\file svn/bin} directory. Thus,

\vspace{\baselineskip}
\centerline{\file svn commit}
\vspace{\baselineskip}

\noindent
called from the {\file svn} directory will update the repository. Note that
this implies that new files need to be added in the {\file svn} directory
first, and then need to be added as links in the conventional directory. The
script {\file install\_ww3\_svn} can be used for either an initial install,
for updating the working copies from the svn repository, and for updating link
to the local {\file svn} directory.

The script {\file install\_ww3\_svn} needs to reside in the main \ws\
directory. Upon first install, this script can be pulled from

\vspace{\baselineskip}
\centerline{\file trunk/model/bin/install\_ww3\_svn}
\vspace{\baselineskip}

\noindent
If this script is found to be identical to the local work copy in the local
{\file svn/bin} directory, it will be replaced with a link to the latter, so
that modifications to the script will also be version controlled with svn.

Co-developers will have read access to the {\file trunk} and {\file tags}, and
will have read and write permission to their workspace in the {\file
branches}. Read access to the latter work space will be set as requested by
the co-developer. NCEP code managers will have read access throughout, and
will be responsible for merging mature codes into the {\file trunk}. As
mentioned above, co-developer will be responsible for providing mature
upgrades relative to the most recent upgrade of the {\file trunk}.

To fully use the potential of subversion, it is critical that detailed commit
logs are maintained. As with the CRTM, \ws\ commit logs should follow the GNU
ChangeLog format\footnote{
~http://www.gnu.org/prep/standards/standards.html\#Change-Logs}. An example of
a log entry is given in Fig.~\ref{fig:log}. The log entry should mention each
file that has been changed. The first line of each block should contain the
subdirectory name. The log entry should mention every file that has been
changed. For every file, every procedure changed should be named in full (no
wildcard) to enable searching the log. We are aware that some duplicity is
introduced by also asking for a change log entry in the actual source
files. The latter is typically only a one-line cryptic description. For now,
this change log will also be maintained because it refers to the \ws\ version
number. If the commit logs are properly maintained, the ChangeLog will be
provided with future releases, at which time we may discontinue the habit of
providing simple change logs in the source files.

\begin{myfig}{tbp}
\begin{center}
\begin{minipage}[c]{4.5in}
{\scriptsize \begin{verbatim}
ww3/branches/hendrik/workcopy/model/aux subdirectory
 * spec_ids: File removed, as it was eroneously added to the repository with
             the initial import of model version 3.14.

ww3/branches/hendrik/workcopy/model/bin subdirectory
 * install_ww3_svn: New script to install wave model from svn reporitory.

ww3/branches/hendrik/workcopy/guide subdirectry (new subdirectory)
 * report.tex: the latex file with the guide
 * report.bib: bibtex bibliography information for guide

ww3/branches/hendrik/workcopy/model/ftn subdirectory
 * w3sbtxmd.ftn: added copyright statement
   (w3sbtx): cosmetic changes
   (insbtx): cleared typos from documentation
\end{verbatim}}
\end{minipage}
\end{center}

\myfcap{Example of commit log entry following the GNU ChangeLog format.}
\label{fig:log}
\end{myfig}


\vspace{\baselineskip}
\noindent
Finally, we are using Trac\footnote{~http://trac.edgewall.org/} as a web-based
management tool for the development of \ww. The Trac pages are found at

\vspace{\baselineskip}
\centerline{\file https://svnemc.ncep.noaa.gov/trac/ww3}
\vspace{\baselineskip}

\noindent
and are accessed with the user name and password of the svn pages. The front
page is a wiki page. Trac gives a web-based way to access files in subversion,
including a time line of submissions to subversion. Additional tools include a
road map with milestones, and a ticket system to track bugs and their fixes,
and to manage code development for \ww\ among co-developers.  Trac will be
accessible to all those with accounts for our subversion server.

\pb

%\vspace{\baselineskip}
\begin{center}
\rule[1mm]{55mm}{1.0mm} NOTE \rule[1mm]{55mm}{1.0mm} \\ 
\vspace{\baselineskip} \label{svn_n}
\parbox{120mm}{To assure that codes can be maintained effectively with
  subversion, make sure that work copies in your branch are created using an
  {\file svn copy} or {\file svn cp} command from the trunk, and not by
  checking in new code form outside the repository. The first approach will
  allow you to easily keep your copy synchronized with the trunk, the latter
  approach will require much manual labor to achieve this. Synchronizing a
  properly generated work copy with the trunk require the following steps:
\begin{itemize}
\item Check out a work copy from your branch in the repository to a work space
      on your local machine.
\item Merge this copy with the trunk using {\file svn merge \ldots}
\item Resolve conflicts and test as needed.
\item Commit merged version to your work space in the repository. This version
      is now up to date with the trunk and also includes your changes, if
      conflict resolution is done properly.
\end{itemize}
As a general rule, do not create branches from branches if you do not want to
create much work to stay synchronized with trunk.} \\
\vspace{\baselineskip} \rule[1mm]{55mm}{1.0mm} NOTE \rule[1mm]{55mm}{1.0mm}
\end{center}

\vspace{\baselineskip}
\begin{center}
\rule[1mm]{55mm}{1.0mm} WARNING \rule[1mm]{55mm}{1.0mm} \\ 
\vspace{\baselineskip} \label{svn_w}
\parbox{120mm}{NCEP code managers WILL NOT accept branches for merge with the
trunk if the branch does not originate from an {\file svn copy} from the
trunk, as NCEP does not have the resources to manually merge each submitted
code.

\vspace{\baselineskip} \noindent 
NEVER download code directly from the web interface to the svn server at NCEP
as this bypasses all svn code management tools. All interactions with the
server other than looking around should be done through command lines at the
svn client. ALWAYS use svn commands to manage local codes (e.g., copies,
moves, adding files) rather than use Unix/Linux commands.} \\
\vspace{\baselineskip} \rule[1mm]{55mm}{1.0mm} WARNING \rule[1mm]{55mm}{1.0mm}
\end{center}


%\bpage
\pb
%--------------------------------------------------------------%
%           References                                         %
%--------------------------------------------------------------%
\addtocontents{toc}{\vspace
{\baselineskip}}
\addcontentsline{toc}{subsection}{References}
\setcounter{footnote}{0}

\bibliographystyle{jas}
\bibliography{report}

\pb
\pagestyle{empty}
\bpagea


\end{document}
