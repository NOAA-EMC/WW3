#!/bin/sh
#############################################################################
#                                                                           #
# ww3_ts1   Test script for WW-III, source term integration in homogeneous  #
#           conditions (1-point model)                                      #
#                                                                           #
# Model should be compiled with the switches :                              #
#                                                                           #
#   !/FLn !/LNn !/STn !/NLn !/BTn !/DBn !/TRn !/BSn !/XXn                   #
#                        Select source term, growth needed, other opt.      #
#   !/PR0                No propagation.                                    #
#   !/WNX1 !/WNT1 !/CRX1 !/CRT1      Wind and current interpolation.        #
#   !/O1 !/O2 !/O3 !/O4 !/O5 !/O6 !/O7   Sdt out output options.            #
#                                                                           #
# Remarks :                                                                 #
# - Check the shell script variable 'grads' and set its environment to      #
#   generate graphical output using GrADS.                                  #
# - There is no check to see if the initial conditions in ww3_strt are      #
#   compatible with the linear growth term. LN0 with type 5 in ww3_strt     #
#   will results in NO WAVE GROWTH.                                         #
# - The grid option needs to be set to XYG to assure proper initialization  #
#   with type 3 in ww3_strt.                                                #
#                                                                           #
#                                              Hendrik Tolman, Jun 2002     #
#                                                   Last Mod : Nov 2009     #
#                                                                           #
#    Copyright 2009 National Weather Service (NWS),                         #
#       National Oceanic and Atmospheric Administration.  All rights        #
#       reserved.  WAVEWATCH III is a trademark of the NWS.                 #
#       No unauthorized use without permission.                             #
#                                                                           #
############################################################################# 

# 0. Preparations -----------------------------------------------------------

  ww3_env='.wwatch3.env'   # setup file
 
  grads='yes'                     # run gx_outp and grads [yes/-]
                                  # set you GrADS environment properly !!

# 0.a Set-up variables

  cd
  if [ -f $ww3_env ]
  then
    set `grep WWATCH3_DIR $ww3_env` ; shift
    main_dir="$*"
    set `grep WWATCH3_TMP $ww3_env` ; shift
    temp_dir="$*"
  else
    echo "*** Set-up file $ww3_env not found ***"
    exit
  fi

  path_w="$temp_dir"              # work directory
  path_e="$main_dir/exe"          # path for executables
  path_a="$main_dir/aux"          # path for gs scripts
  path_o="$main_dir/test"         # path for output files
# path_o="$main_dir/work"

# 0.b Clean-up

# clear
  rm -f $path_o/ww3_????.out
  rm -f $path_o/gx_????.out
  rm -f $path_o/log.ww3
  rm -f $path_o/test.ww3
  rm -f $path_o/tab??.ww3
  rm -f $path_o/*.ps

  cd $path_w
  rm -f *.ww3 *.gs

  echo ' ' ; echo ' '
  echo '                  ======> TEST RUN WAVEWATCH III <====== '
  echo '                    ==================================   '
  echo '                                   homogeneous source term test'
  echo '                                   homogeneous conditions'
  echo ' '

# 1. Grid pre-processor -----------------------------------------------------

  echo ' '
  echo '+--------------------+'
  echo '|  Grid preprocessor |'
  echo '+--------------------+'
  echo ' '

cat > ww3_grid.inp << EOF
$ WAVEWATCH III Grid preprocessor input file
$ ------------------------------------------
  'HOMOGENEOUS SOURCE TERM TEST  '
$
   1.10  0.042  25  24  0.
$  1.07  0.042  40  36  0.
$
   F F F F F T
$ 900.  900.  900.  5.
  900.  900.  900. 15.
$ 900.  900.  900. 60.
$
$ &MISC  XP = 0.025 /                                                        
$ &FLX3  CDMAX = 2.5E-3, CTYPE = 1 /
$ &SLN1  RFPM = 1.0 RFHF = 0.33 /
  &MISC  XP = 0.075 /
END OF NAMELISTS
$
   'RECT' T F
   3   3
   1.  1.  1.E-4
  -1. -1.  1.E-4
$
  -5. 5.75  10  -2500. 3 1 '(....)' 'UNIT' 'input'
$
   1  1  1
   1  1  1
   1  1  1
$
  10  1 1 '(....)' 'PART' 'input'
$
   0  0  F
   0  0  F
   0  0
$
   0. 0. 0. 0.  0
EOF

  echo "   Screen ouput routed to $path_o/ww3_grid.out"
  $path_e/ww3_grid > $path_o/ww3_grid.out

  rm -f ww3_grid.inp

# 2. Initial conditions -----------------------------------------------------

  echo ' '
  echo '+--------------------+'
  echo '| Initial conditions |'
  echo '+--------------------+'
  echo ' '

cat > ww3_strt.inp << EOF
$ WAVEWATCH III Initial conditions input file
$ -------------------------------------------
$ 2
$ 0.0  0.30  270.  3.3 0. 0. 0. 1. 0. 1.
$ 3
  5
$
EOF

  echo "   Screen ouput routed to $path_o/ww3_strt.out"
  $path_e/ww3_strt > $path_o/ww3_strt.out

  rm -f ww3_strt.inp

# 3. Main program -----------------------------------------------------------

  echo ' '
  echo '+--------------------+'
  echo '|    Main program    |'
  echo '+--------------------+'
  echo ' '

cat > ww3_shel.inp << EOF
$ WAVEWATCH III shell input file
$ ------------------------------
   F T
   F T
   T T
   F
   F
   F
   F
$
   19680606 000000
   19680607 000000
$
   1
$
   19680606 000000      0  19680608 000000
   19680606 000000   3600  19680618 000000
     0.0   0.0  'The_point '
     0.0   0.0  'STOPSTRING'
   19680607 000000      0  19680608 000000
   19680607 000000      0  19680608 000000
   19680606 000000      0  19680608 000000
   19680606 000000      0  19680608 000000
$
   'WND' 19680606 000000   20.   270.  -20.
   'WND' 19680606 020000   20.   270.  -20.
   'WND' 19680606 030000   20.   270.  -20.
   'WND' 19680606 040000   20.   270.  -20.
   'WND' 19680606 050000   20.   270.  -20.
   'STP'
EOF

  $path_e/ww3_shel
  rm -f ww3_shel.inp

  echo ' ' ; echo "   Output file log.ww3 routed to $path_o"
  mv log.ww3 $path_o/.
  if [ -f test.ww3 ]
  then
    echo "   Output file test.ww3 routed to $path_o"
    mv test.ww3 $path_o/.
  fi

# exit 99

# 4. Gridded output ---------------------------------------------------------

# echo ' '
# echo '+--------------------+'
# echo '|   Gridded output   |'
# echo '+--------------------+'
# echo ' '

# 5. Point output -----------------------------------------------------------

  echo ' '
  echo '+--------------------+'
  echo '|    Point output    |'
  echo '+--------------------+'
  echo ' '

  echo '   Table of mean wave parameters'

cat > ww3_outp.inp << EOF
$ WAVEWATCH III Point output post-processing
$ ------------------------------------------
  19680606 000000  3600. 999
$
  1
 -1
$
  2
$
  2  50
EOF

  echo "   Screen ouput routed to $path_o/ww3_op_1.out"

  $path_e/ww3_outp > $path_o/ww3_op_1.out

  echo "   Table file tab50.ww3 routed to $path_o"
  mv tab50.ww3 $path_o
  rm -f ww3_outp.inp

  echo ' '
  echo '   Print plots of spectra (in screen output)'

cat > ww3_outp.inp << EOF
$ WAVEWATCH III Point output post-processing
$ ------------------------------------------
  19680606 000000  10800.  999
$
  1
 -1
$
  1
$
  1   0.  0.  33  T
EOF

  echo "   Screen ouput routed to $path_o/ww3_op_2.out"

  $path_e/ww3_outp > $path_o/ww3_op_2.out

  rm -f ww3_outp.inp

  if [ "$grads" = 'yes' ]
  then

  echo '   GrADS spectra'

cat > gx_outp.inp << EOF
$ WAVEWATCH III Point output post-processing (GrADS)
$ --------------------------------------------------
  19680606 000000 10800. 999
$
  1
 -1
$
  T T T T T T
EOF

    echo "   Screen output routed to $path_o/gx_outp.out"
    $path_e/gx_outp > $path_o/gx_outp.out

    rm -f gx_outp.inp

    ln -s $path_a/colorset.gs .
    ln -s $path_a/spec.gs     .
    ln -s $path_a/source.gs   .
    echo 'script ww3_ts1'         > spec_ids
    echo 'WAVEWATCH III TEST'    >> spec_ids

# Set up GrADS properly here if necessary!!!

cat > input << EOF

EOF

    cat input input | grads -pbc "run spec"

    gxeps -c -i plot.grads -o $path_o/spec.eps

    rm -f plot.grads

    echo ' '
    echo '   GrADS sources'

    cat input input input input input input input | grads -pbc "run source"

    gxeps -c -i plot.grads -o $path_o/source.eps

    rm -f input plot.grads ww3.* *.gs spec_ids

fi

# 6. End, cleaning up -------------------------------------------------------

  echo ' ' ; echo ' ' ; echo "Files in `pwd` :" ; echo ' '
  ls -l *.ww3

  echo ' ' ; echo "Cleaning-up `pwd`"
  rm -f *.ww3

  echo ' ' ; echo "Files in $path_o :" ; echo ' '
  cd $path_o
  ls -l ww3_????.out
  if [ "$grads" = 'yes' ]
  then
    ls -l gx_*.out
  fi
  ls -l *.ww3
  if [ "$grads" = 'yes' ]
  then
    ls -l *.eps
  fi

  echo ' ' ; echo ' '
  echo '                  ======>  END OF WAVEWATCH III  <====== '
  echo '                    ==================================   '
  echo ' '

# End of ww3_ts1 ------------------------------------------------------------
