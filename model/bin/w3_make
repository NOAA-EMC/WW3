#!/bin/sh
# --------------------------------------------------------------------------- #
# w3_make : Compile and link WAVEWATCH III programs using standard make and   #
#           makefile methods.                                                 #
#                                                                             #
# use     : w3_make [program [...]]                                           #
#              program: program name of WAVEWATCH III (sub)program.           #
#                                                                             #
# error codes : Program ends if error occurs in make_makefile.sh.             #
#                                                                             #
# programs used :                                                             #
#       make_makefile.sh :  Makes the makefile.                               #
#                                                                             #
# programs called from the makefile :                                         #
#       ad3   : script to execute preprocessor and to compile.                #
#       link  : linker script.                                                #
#                                                                             #
#                                                      Hendrik L. Tolman      #
#                                                      May 2009               #
#                                                      Aug. 2010              #
#                                                                             #
#    Copyright 2009-2010 National Weather Service (NWS),                      #
#       National Oceanic and Atmospheric Administration.  All rights          #
#       reserved.  WAVEWATCH III is a trademark of the NWS.                   #
#       No unauthorized use without permission.                               #
#                                                                             #
# --------------------------------------------------------------------------- #
# 1. Preparations                                                             #
# --------------------------------------------------------------------------- #
# 1.a Internal variables

  ww3_env="${HOME}/.wwatch3.env"                           # setup file
  if [ ${WWATCH3_ENV} ]; then ww3_env="${WWATCH3_ENV}"; fi # alternate setup file

# 1.b ID header  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  echo ' '
  echo '                    *****************************'
  echo '                  ***  compiling WAVEWATCH III  ***'
  echo '                    *****************************'
  echo ' '

# 1.c Process/save input - - - - - - - - - - - - - - - - - - - - - - - - - - - 

  if test "$#" = '0'
  then
    progs='ww3_grid ww3_strt ww3_prep ww3_shel ww3_outf ww3_outp
           ww3_trck ww3_grib gx_outf gx_outp ww3_ounf ww3_ounp'
    progs="$progs ww3_multi ww3_sbs1 ww3_gint"
  else
    progs="$*"
  fi

# 1.d Get data from setup file - - - - - - - - - - - - - - - - - - - - - - - - 

  if test -f $ww3_env
  then
    set `grep WWATCH3_DIR $ww3_env` ; shift
    main_dir="$*"
    set `grep WWATCH3_TMP $ww3_env` ; shift
    temp_dir="$*"
    set `grep WWATCH3_SOURCE $ww3_env` ; shift
    source="$*"
    set `grep WWATCH3_LIST $ww3_env` ; shift
    list="$*"
  else
    echo "*** Set-up file $ww3_env not found ***"
    exit
  fi

  echo "Scratch directory : $temp_dir"
  echo "Save source codes : $source"
  echo "Save listings     : $list"
  echo ' '

# 1.e Prepare scratch directory  - - - - - - - - - - - - - - - - - - - - - - - 

  if test ! -d $temp_dir
  then
    if ! `mkdir -p $temp_dir`
    then
      echo ' ' ; echo "      *** Cannot create $temp_dir ***" ; echo ' '
      exit
    fi
  fi

  cd $temp_dir
  rm -f *.f *.f90
  rm -f *.l
  cd $main_dir/ftn

# 1.f Prepare makefile - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  if test ! -f $main_dir/bin/switch
  then
    echo ' ' ; echo "      *** switch file not found ***" ; echo ' '
    exit
  fi

  make_make='y'
  if test -f $main_dir/bin/switch.old
  then
    if test -f $main_dir/ftn/makefile && \
       test -z "`diff $main_dir/bin/switch $main_dir/bin/switch.old`"
    then
      make_make='n'
    fi
  fi

  if test "$make_make" = 'y'
  then
    echo 'Making makefile ...'
    if $main_dir/bin/make_makefile.sh
    then
      cp $main_dir/bin/switch $main_dir/bin/switch.old
    else
      exit 1
    fi
  fi
  echo ' '

# 1.g Export paths - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

  aPb="$main_dir/bin"     # path containing shell scripts
  aPo="$main_dir/obj"     # path containing .o files
  aPm="$main_dir/mod"     # path containing .mod files
  aPe="$main_dir/exe"     # path containing executables

  export aPb aPo aPm aPe

# --------------------------------------------------------------------------- #
# 2. Run make for all requests                                                #
# --------------------------------------------------------------------------- #
# 2.a Loop over all requests

  for prog in $progs
  do
    echo "Processing $prog"
    echo "---------------------"

# 2.b Check input  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

    OK='n'
    checks='ww3_grid ww3_strt ww3_prep ww3_shel ww3_multi ww3_sbs1
            ww3_outf ww3_outp ww3_trck ww3_grib ww3_gint gx_outf gx_outp ww3_ounf ww3_ounp ww3_prnc'

    for check in $checks
    do
      if test "$prog" = "$check"
      then
        OK='y'
        if [ "$check" = 'ww3_ounf' ] || [ "$check" = 'ww3_ounp' ] || [ "$check" = 'ww3_prnc' ]
        then

          # check value of WWATCH3_NETCDF environnment variable
          WWATCH3_NC="$(env | grep WWATCH3_NETCDF | cut -d "=" -f 2)"
          echo  "WWATCH3_NETCDF = $WWATCH3_NC"

          # NC4
          if [ "$WWATCH3_NC" = "NC4" ]
          then
            # check if netCDF4 library is installed
            if [ "$(nc-config --has-nc4)" != "yes" ]
            then
              echo "*** NetCDF4 library need to be compiled on your system or delete NC4 from switch file ***"
              exit
            fi

          # NC3
          elif [ "$WWATCH3_NC" = "NC3" ]
          then
            # check if NC4 is present in switch file or not
            if [ "$(grep -o NC4 $main_dir/bin/switch)" = "NC4" ]
            then
              echo  "*** WWATCH3_NETCDF need to be set to NC4 or delete NC4 from switch file ***"
              exit
            fi
            # NETCDF3_INCDIR
            NC3_INCDIR="$(env | grep NETCDF3_INCDIR | cut -d "=" -f 2)"
            if [ "$NC3_INCDIR" != "" ]
            then
              echo "NETCDF3_INCDIR = $NC3_INCDIR"
            else
              echo  "*** NETCDF3_INCDIR need to be set. [/usr/local/include] ***"
              exit
            fi
            # NETCDF3_LIBDIR
            NC3_LIBDIR="$(env | grep NETCDF3_LIBDIR | cut -d "=" -f 2)"
            if [ "$NC3_LIBDIR" != "" ]
            then
              echo "NETCDF3_LIBDIR = $NC3_LIBDIR"
            else
              echo  "*** NETCDF3_LIBDIR need to be set. [/usr/local/lib] ***"
              exit
            fi

          # Other
          else
            echo  "*** WWATCH3_NETCDF need to be set. [NC3 or NC4] ***"
            exit
          fi
        fi
      fi
    done
    if test "$OK" = 'n'
    then
      echo "   *** Program name not recognized ***"
      echo ' '

# 2.c Run make - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

    else
      path_m=$main_dir/mod
      export path_m
      make -f makefile $aPe/$prog
      echo ' '
    fi
  done

# --------------------------------------------------------------------------- #
# 3. End of program ID.                                                       #
# --------------------------------------------------------------------------- #

  echo ' '
  echo '                       **********************'
  echo '                     *** end of compilation ***'
  echo '                       **********************'
  echo ' '

# End of w3_make ------------------------------------------------------------ #
